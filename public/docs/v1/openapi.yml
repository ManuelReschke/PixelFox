openapi: "3.0.0"
info:
  version: 1.0.0
  title: PixelFox.cc API v1
  description: WORK IN PROGRESS - Official API for PixelFox image sharing platform
  contact:
    name: PixelFox API Support
    url: https://pixelfox.cc
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8080/api/v1
    description: Development server
  - url: https://pixelfox.cc/api/v1
    description: Production server

tags:
  - name: Health
    description: Health check endpoints
  - name: Upload
    description: Upload sessions and direct upload helpers
  - name: Users
    description: User management
  - name: Albums
    description: Album management
  - name: Images
    description: Image resources and processing status

paths:
  /ping:
    get:
      summary: Health check endpoint
      description: Returns a simple pong response to verify API availability
      operationId: getPing
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Successful health check response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Pong'
        '500': { $ref: '#/components/responses/InternalError' }
  /user/profile:
    get:
      summary: Get authenticated user profile
      description: Returns account details, usage statistics, and limits for the authenticated user.
      operationId: getUserProfile
      tags:
        - Users
      security:
        - ApiKeyAuth: []
      responses:
        '200':
          description: User profile loaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAccount'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }
        '500': { $ref: '#/components/responses/InternalError' }
  /upload/sessions:
    post:
      summary: Issue direct upload session
      description: >-
        Creates a direct upload session and returns a temporary upload token.
        Use the returned `upload_url` as the upload target URL for file transfer.
      operationId: postUserUploadSession
      tags:
        - Upload
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadSessionRequest'
      responses:
        '200':
          description: Upload session issued successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadSessionResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '403': { $ref: '#/components/responses/Forbidden' }
        '413': { $ref: '#/components/responses/PayloadTooLarge' }
        '500': { $ref: '#/components/responses/InternalError' }
        '503': { $ref: '#/components/responses/ServiceUnavailable' }

  /upload:
    post:
      summary: Direct storage upload
      description: >-
        Uploads an image file directly to storage using a time-limited upload token.
        Use the `upload_url` returned by `POST /upload/sessions` as the target URL.
        This endpoint returns immediately after accepting the upload and queueing processing.
        The response is not a guarantee that all variants are already generated.
        Poll `GET /images/{uuid}/status` until `complete=true`.
        If `failed=true`, processing ended with an error.
        When `complete=true` and `failed=false`, fetch final image resource data via `GET /images/{uuid}`.
        This endpoint is also available on `/api/v1/upload` as a compatibility route.
      operationId: postDirectUpload
      tags:
        - Upload
      security:
        - UploadTokenAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
                token:
                  type: string
                  description: "Alternative to Authorization header: pass upload token as multipart field"
              required: [file]
      responses:
        '200':
          description: Upload accepted and processing started asynchronously
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StorageUploadResponse'
        '400': { $ref: '#/components/responses/BadRequest' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '413': { $ref: '#/components/responses/PayloadTooLarge' }
        '415': { $ref: '#/components/responses/UnsupportedMediaType' }
        '429': { $ref: '#/components/responses/TooManyRequests' }
        '500': { $ref: '#/components/responses/InternalError' }

  /images/{uuid}/status:
    get:
      summary: Get processing status
      description: Returns whether the image processing is complete and the view URL if available.
      operationId: getImageStatus
      tags:
        - Images
      security:
        - ApiKeyAuth: []
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Status response
          content:
            application/json:
              schema:
                type: object
                properties:
                  complete:
                    type: boolean
                  failed:
                    type: boolean
                  view_url:
                    type: string
                    nullable: true
        '400': { $ref: '#/components/responses/BadRequest' }

  /images/{uuid}:
    get:
      summary: Get image resource
      description: Returns direct URL and available variant links for the image.
      operationId: getImage
      tags:
        - Images
      security:
        - ApiKeyAuth: []
      parameters:
        - name: uuid
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Image resource
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ImageResource'
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }

components:
  responses:
    BadRequest:
      description: Invalid request payload
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Missing or invalid authentication
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Forbidden:
      description: Account not allowed to perform this action
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    PayloadTooLarge:
      description: Requested file size exceeds plan or quota limits
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    UnsupportedMediaType:
      description: Unsupported media type
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    TooManyRequests:
      description: Too many requests
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    ServiceUnavailable:
      description: Service unavailable
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  schemas:
    # Upload result now can include direct URL and variant links
    StorageUploadResponse:
      type: object
      properties:
        image_uuid:
          type: string
          description: UUID of the uploaded image
        view_url:
          type: string
          description: Share page URL (HTML view)
        url:
          type: string
          format: uri
          description: Direct URL to the original image file
        duplicate:
          type: boolean
          description: Indicates the uploaded file already exists for this user
        available_variants:
          type: array
          description: List of available variant-families for this image
          items:
            type: string
            enum: ["original", "webp", "avif"]
        variants:
          type: object
          description: URLs of available variants grouped by family
          properties:
            original:
              $ref: '#/components/schemas/FormatVariants'
            webp:
              $ref: '#/components/schemas/FormatVariants'
            avif:
              $ref: '#/components/schemas/FormatVariants'
          additionalProperties: false

    # Canonical image resource (shared structure with StorageUploadResponse sans duplicate)
    ImageResource:
      type: object
      required: [image_uuid]
      properties:
        image_uuid:
          type: string
        view_url:
          type: string
          description: Share page URL (HTML view)
        url:
          type: string
          format: uri
          description: Direct URL to the original image file
        available_variants:
          type: array
          description: List of available variant-families for this image
          items:
            type: string
            enum: ["original", "webp", "avif"]
        variants:
          type: object
          description: URLs of available variants grouped by family
          properties:
            original:
              $ref: '#/components/schemas/FormatVariants'
            webp:
              $ref: '#/components/schemas/FormatVariants'
            avif:
              $ref: '#/components/schemas/FormatVariants'
          additionalProperties: false

    # Variant schemas (generalized: families original/webp/avif; sizes original/medium/small)
    VariantSize:
      type: object
      required: [url]
      properties:
        url:
          type: string
          format: uri
        width:
          type: integer
          description: Pixel width if known
        height:
          type: integer
          description: Pixel height if known
        bytes:
          type: integer
          format: int64
          minimum: 0
          description: File size in bytes if known
        mime_type:
          type: string
          description: MIME type of this asset
        animated:
          type: boolean
          description: Whether this asset is animated (e.g., GIF/WebP)

    FormatVariants:
      type: object
      properties:
        original:
          $ref: '#/components/schemas/VariantSize'
        medium:
          $ref: '#/components/schemas/VariantSize'
        small:
          $ref: '#/components/schemas/VariantSize'
      additionalProperties: false
    # Health check schemas
    Pong:
      type: object
      required:
        - ping
      properties:
        ping:
          type: string
          example: pong
          description: Simple response confirming API availability

    # Error handling schemas
    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type identifier
          example: "internal_server_error"
        message:
          type: string
          description: Human-readable error message
          example: "An unexpected error occurred"
        details:
          type: string
          description: Additional error details
          example: "Database connection failed"

    UploadSessionRequest:
      type: object
      required:
        - file_size
      properties:
        file_size:
          type: integer
          format: int64
          minimum: 1
          description: File size in bytes.

    UploadSessionResponse:
      type: object
      required:
        - upload_url
        - token
        - pool_id
        - expires_at
        - max_bytes
      properties:
        upload_url:
          type: string
          format: uri
          description: Absolute URL of the upload endpoint.
        token:
          type: string
          description: Time-limited upload token (Bearer token).
        pool_id:
          type: integer
          format: int64
          description: Identifier of the selected storage pool.
        expires_at:
          type: integer
          format: int64
          description: Expiration time as a Unix timestamp (seconds).
        max_bytes:
          type: integer
          format: int64
          description: Maximum file size in bytes accepted with this token.

    UserAccount:
      type: object
      required:
        - id
        - username
        - email
        - status
        - plan
        - created_at
        - stats
        - limits
        - preferences
      properties:
        id:
          type: integer
          format: int64
          description: User ID
          example: 42
        username:
          type: string
          description: User display name
          example: pixelpete
        email:
          type: string
          format: email
          description: Linked email address
          example: pete@example.com
        status:
          type: string
          description: Account status
          example: active
        plan:
          type: string
          description: Current subscription plan
          example: premium

        created_at:
          type: string
          format: date-time
          description: Registration timestamp
        last_login_at:
          type: string
          format: date-time
          nullable: true
          description: Timestamp of the last login (if available)
        api_key_last_used_at:
          type: string
          format: date-time
          nullable: true
          description: Last usage timestamp of the current API key
        stats:
          $ref: '#/components/schemas/UserAccountStats'
        limits:
          $ref: '#/components/schemas/UserAccountLimits'
        preferences:
          $ref: '#/components/schemas/UserAccountPreferences'

    UserAccountStats:
      type: object
      required:
        - images
        - albums
      properties:
        images:
          type: object
          required:
            - count
            - storage_used_bytes
          properties:
            count:
              type: integer
              format: int64
              description: Number of stored images
              example: 128
            storage_used_bytes:
              type: integer
              format: int64
              description: Used storage in bytes
              example: 734003200
            storage_remaining_bytes:
              type: integer
              format: int64
              nullable: true
              description: Remaining storage in bytes (null if unlimited)
        albums:
          type: object
          required:
            - count
          properties:
            count:
              type: integer
              format: int64
              description: Number of created albums
              example: 12

    UserAccountLimits:
      type: object
      required:
        - max_upload_bytes
        - storage_quota_bytes
        - can_multi_upload
        - image_upload_enabled
        - direct_upload_enabled
        - allowed_thumbnail_formats
      properties:
        max_upload_bytes:
          type: integer
          format: int64
          description: Maximum upload size per file (in bytes)
          example: 52428800
        storage_quota_bytes:
          type: integer
          format: int64
          nullable: true
          description: Total available storage (null if unlimited)
        can_multi_upload:
          type: boolean
          description: Whether multi-upload is allowed
        image_upload_enabled:
          type: boolean
          description: Global setting for image uploads
        direct_upload_enabled:
          type: boolean
          description: Global setting for direct uploads
        allowed_thumbnail_formats:
          type: array
          items:
            type: string
          description: Available thumbnail formats
          example: ["original", "webp"]

    UserAccountPreferences:
      type: object
      required:
        - thumbnail_original
        - thumbnail_webp
        - thumbnail_avif
      properties:
        thumbnail_original:
          type: boolean
          description: Prefers original thumbnails
        thumbnail_webp:
          type: boolean
          description: Prefers WebP thumbnails
        thumbnail_avif:
          type: boolean
          description: Prefers AVIF thumbnails

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for authentication
    UploadTokenAuth:
      type: http
      scheme: bearer
      bearerFormat: token
      description: Time-limited upload token for direct storage upload

security:
  - ApiKeyAuth: []
